# NHS Companion - Project Planning Pack

## Table of Contents
1. [Assumptions](#1-assumptions)
2. [Requirements & Non-goals](#2-requirements--non-goals)
3. [Recommended Architecture](#3-recommended-architecture)
4. [Schema Design](#4-schema-design)
5. [Convex Function List](#5-convex-function-list)
6. [Auth & RBAC Rules](#6-auth--rbac-rules)
7. [Attendance Verification Design](#7-attendance-verification-design)
8. [UI Screen Map & Components](#8-ui-screen-map--components)
9. [Milestones & Checklist](#9-milestones--checklist)
10. [Testing & QA](#10-testing--qa)
11. [Open Questions](#11-open-questions)

---

## 1. Assumptions

### User & Organization Context
- **A1**: Single NHS chapter per deployment (multi-tenancy not required for MVP)
- **A2**: Typical chapter size: 20-200 students, 1-5 admins/sponsors
- **A3**: School year runs August-May; data retention of 4 years (typical high school tenure)
- **A4**: Students have smartphones; mobile-first but desktop-accessible
- **A5**: School email domains can be used for basic verification (e.g., `@schoolname.edu`)

### Technical Assumptions
- **A6**: Convex Auth will use email/password + magic link (no OAuth needed for MVP)
- **A7**: Email sending via Resend (Convex-compatible, simple setup)
- **A8**: File uploads limited to 10MB per file (reasonable for photos/PDFs)
- **A9**: No offline support required (school has WiFi coverage)
- **A10**: Time zones: single timezone per chapter (stored in config)

### Business Logic Assumptions
- **A11**: Service hours are submitted in 0.25-hour increments, max 12 hours per submission
- **A12**: Meetings typically last 30-90 minutes; check-in window is meeting duration + 15 min buffer
- **A13**: Students can edit pending submissions but not approved/denied ones
- **A14**: Admins can retroactively approve attendance (for edge cases)
- **A15**: One proof file per service submission (can be multi-page PDF)

---

## 2. Requirements & Non-goals

### In Scope (MVP)
| ID | Feature | Priority |
|----|---------|----------|
| R1 | Email/password authentication with magic link option | P0 |
| R2 | Student profile creation with admin verification | P0 |
| R3 | Service hours submission with file upload | P0 |
| R4 | Admin approval/denial workflow with notes | P0 |
| R5 | Meeting creation and management | P0 |
| R6 | Attendance check-in with anti-sharing protection | P0 |
| R7 | In-app notifications | P0 |
| R8 | Service opportunities browsing | P1 |
| R9 | Calendar view (meetings + events) | P1 |
| R10 | Email notifications | P1 |
| R11 | Audit logging | P1 |
| R12 | CSV export for admins | P2 |
| R13 | Scheduled reminders | P2 |

### Non-goals (Explicitly Out of Scope)
- Multi-chapter/district management
- Parent portal or parent accounts
- Integration with school SIS (Student Information System)
- Native mobile apps (PWA-capable web app only)
- Offline mode
- Real-time chat or messaging between users
- Payment processing for dues
- Social features (comments, reactions, leaderboards)
- SMS notifications (email only)
- SSO/SAML integration

---

## 3. Recommended Architecture

### Folder Structure
```
nhs-companion/
â”œâ”€â”€ convex/
â”‚   â”œâ”€â”€ _generated/           # Auto-generated by Convex
â”‚   â”œâ”€â”€ schema.ts             # Database schema
â”‚   â”œâ”€â”€ auth.ts               # Auth configuration
â”‚   â”œâ”€â”€ http.ts               # HTTP routes (webhooks)
â”‚   â”‚
â”‚   â”œâ”€â”€ functions/
â”‚   â”‚   â”œâ”€â”€ users.ts          # User/profile queries & mutations
â”‚   â”‚   â”œâ”€â”€ serviceHours.ts   # Service submission logic
â”‚   â”‚   â”œâ”€â”€ attendance.ts     # Meeting & check-in logic
â”‚   â”‚   â”œâ”€â”€ calendar.ts       # Calendar events
â”‚   â”‚   â”œâ”€â”€ opportunities.ts  # Service opportunities
â”‚   â”‚   â”œâ”€â”€ notifications.ts  # Notification handling
â”‚   â”‚   â””â”€â”€ admin.ts          # Admin-specific functions
â”‚   â”‚
â”‚   â”œâ”€â”€ actions/
â”‚   â”‚   â”œâ”€â”€ email.ts          # Email sending (Resend)
â”‚   â”‚   â””â”€â”€ scheduled.ts      # Cron jobs
â”‚   â”‚
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ permissions.ts    # RBAC helpers
â”‚       â”œâ”€â”€ validation.ts     # Input validation schemas
â”‚       â””â”€â”€ constants.ts      # App constants
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â”œâ”€â”€ page.tsx                    # Landing/redirect
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â”‚   â”œâ”€â”€ login/page.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ signup/page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ verify-email/page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ (student)/
â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx              # Student nav wrapper
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/page.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ submit-hours/page.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ submissions/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx            # History list
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ [id]/page.tsx       # Detail view
â”‚   â”‚   â”‚   â”œâ”€â”€ check-in/page.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ calendar/page.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ opportunities/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ [id]/page.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ notifications/page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ profile/page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ (admin)/
â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx              # Admin nav wrapper
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/page.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ students/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx            # Roster + verification
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ [id]/page.tsx       # Student detail
â”‚   â”‚   â”‚   â”œâ”€â”€ submissions/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx            # Review queue
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ [id]/page.tsx       # Review detail
â”‚   â”‚   â”‚   â”œâ”€â”€ meetings/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ new/page.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ [id]/page.tsx       # Meeting detail + attendance
â”‚   â”‚   â”‚   â”œâ”€â”€ opportunities/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ new/page.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ announcements/page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ exports/page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ api/
â”‚   â”‚       â””â”€â”€ [...convex]/route.ts    # Convex HTTP handler
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ui/                         # shadcn/ui components
â”‚   â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”‚   â”œâ”€â”€ AppShell.tsx            # Main sidebar + content wrapper
â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx             # Fixed left sidebar (role-aware)
â”‚   â”‚   â”‚   â”œâ”€â”€ SidebarNav.tsx          # Nav items with icons
â”‚   â”‚   â”‚   â”œâ”€â”€ SidebarSection.tsx      # Collapsible section (Quick Filters)
â”‚   â”‚   â”‚   â”œâ”€â”€ TopBar.tsx              # Search + notifications + actions
â”‚   â”‚   â”‚   â”œâ”€â”€ UserMenu.tsx            # Profile dropdown
â”‚   â”‚   â”‚   â””â”€â”€ MobileNav.tsx           # Bottom tabs for mobile
â”‚   â”‚   â”œâ”€â”€ landing/
â”‚   â”‚   â”‚   â”œâ”€â”€ LandingNav.tsx          # Minimal nav for landing
â”‚   â”‚   â”‚   â””â”€â”€ HeroSection.tsx         # Gradient hero with CTA
â”‚   â”‚   â”œâ”€â”€ cards/
â”‚   â”‚   â”‚   â”œâ”€â”€ SubmissionCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ MeetingCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ OpportunityCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ActivityCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ StatsCard.tsx
â”‚   â”‚   â”‚   â””â”€â”€ QuickFilterCard.tsx
â”‚   â”‚   â”œâ”€â”€ forms/
â”‚   â”‚   â”‚   â”œâ”€â”€ ServiceHoursForm.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ MeetingForm.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ OpportunityForm.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileForm.tsx
â”‚   â”‚   â”‚   â””â”€â”€ AnnouncementForm.tsx
â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”œâ”€â”€ checkin/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CheckInCodeDisplay.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ CheckInInput.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ review/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ReviewActions.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ submissions/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SubmissionTimeline.tsx
â”‚   â”‚   â”‚   â””â”€â”€ attendance/
â”‚   â”‚   â”‚       â””â”€â”€ AttendanceList.tsx
â”‚   â”‚   â””â”€â”€ shared/
â”‚   â”‚       â”œâ”€â”€ StatusBadge.tsx
â”‚   â”‚       â”œâ”€â”€ FileUpload.tsx
â”‚   â”‚       â”œâ”€â”€ Calendar.tsx
â”‚   â”‚       â”œâ”€â”€ NotificationBell.tsx
â”‚   â”‚       â”œâ”€â”€ NotificationBadge.tsx
â”‚   â”‚       â”œâ”€â”€ SearchInput.tsx
â”‚   â”‚       â”œâ”€â”€ EmptyState.tsx
â”‚   â”‚       â””â”€â”€ LoadingState.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useAuth.ts
â”‚   â”‚   â”œâ”€â”€ useRole.ts
â”‚   â”‚   â””â”€â”€ useNotifications.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ utils.ts
â”‚   â”‚   â””â”€â”€ constants.ts
â”‚   â”‚
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ globals.css
â”‚
â”œâ”€â”€ public/
â”œâ”€â”€ package.json
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ convex.json
â””â”€â”€ tsconfig.json
```

### Key Architectural Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Auth | Convex Auth (email/password + magic link) | Native integration, no external deps |
| File Storage | Convex Storage | Built-in, secure, no S3 config needed |
| Email | Resend via Convex Actions | Simple API, good free tier, Convex-friendly |
| State Management | Convex reactive queries | No Redux/Zustand needed; real-time by default |
| Forms | React Hook Form + Zod | Type-safe validation, good DX |
| Date/Time | date-fns | Lightweight, tree-shakeable |
| UI Components | shadcn/ui | Copy-paste ownership, Tailwind-native |

---

## 4. Schema Design

### Core Tables

```typescript
// convex/schema.ts
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  // ============ USER & AUTH ============

  users: defineTable({
    // Convex Auth fields (auto-populated)
    email: v.string(),
    emailVerified: v.boolean(),

    // App fields
    role: v.union(
      v.literal("student"),
      v.literal("officer"),
      v.literal("admin")
    ),
    profileId: v.optional(v.id("profiles")),
    isActive: v.boolean(),
    lastLoginAt: v.optional(v.number()),
    createdAt: v.number(),
  })
    .index("by_email", ["email"])
    .index("by_role", ["role"]),

  profiles: defineTable({
    userId: v.id("users"),
    firstName: v.string(),
    lastName: v.string(),
    grade: v.union(
      v.literal(9),
      v.literal(10),
      v.literal(11),
      v.literal(12)
    ),
    studentId: v.optional(v.string()), // School ID, optional

    // Verification
    verificationStatus: v.union(
      v.literal("pending"),
      v.literal("verified"),
      v.literal("rejected")
    ),
    verifiedAt: v.optional(v.number()),
    verifiedBy: v.optional(v.id("users")),
    rejectionReason: v.optional(v.string()),

    // Stats (denormalized for fast dashboard)
    totalApprovedHours: v.number(),
    totalPendingHours: v.number(),
    meetingsAttended: v.number(),

    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_userId", ["userId"])
    .index("by_verificationStatus", ["verificationStatus"])
    .index("by_grade", ["grade"])
    .index("by_lastName", ["lastName"]),

  // ============ SERVICE HOURS ============

  serviceSubmissions: defineTable({
    studentId: v.id("users"),
    profileId: v.id("profiles"),

    // Service details
    organizationName: v.string(),
    serviceDate: v.string(), // ISO date string "2024-01-15"
    startTime: v.string(),   // "09:00"
    endTime: v.string(),     // "12:00"
    totalHours: v.number(),  // Calculated, stored for queries
    description: v.string(),

    // Supervisor contact
    supervisorName: v.string(),
    supervisorEmail: v.string(),
    supervisorPhone: v.optional(v.string()),

    // Evidence
    evidenceFileId: v.optional(v.id("_storage")),
    evidenceFileName: v.optional(v.string()),

    // Status workflow
    status: v.union(
      v.literal("pending"),
      v.literal("approved"),
      v.literal("denied"),
      v.literal("revision_requested")
    ),

    // Review info
    reviewedBy: v.optional(v.id("users")),
    reviewedAt: v.optional(v.number()),
    reviewNotes: v.optional(v.string()),

    // Resubmission tracking
    previousSubmissionId: v.optional(v.id("serviceSubmissions")),
    resubmissionCount: v.number(),

    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_studentId", ["studentId"])
    .index("by_status", ["status"])
    .index("by_studentId_status", ["studentId", "status"])
    .index("by_serviceDate", ["serviceDate"])
    .index("by_createdAt", ["createdAt"])
    .index("by_reviewedBy", ["reviewedBy"]),

  // ============ ATTENDANCE ============

  meetings: defineTable({
    title: v.string(),
    description: v.optional(v.string()),
    location: v.string(),

    // Timing
    scheduledDate: v.string(),    // ISO date "2024-01-15"
    scheduledStartTime: v.string(), // "15:30"
    scheduledEndTime: v.string(),   // "16:30"

    // Check-in control
    checkInStatus: v.union(
      v.literal("not_started"),
      v.literal("open"),
      v.literal("closed")
    ),
    checkInOpenedAt: v.optional(v.number()),
    checkInClosedAt: v.optional(v.number()),

    // Anti-cheat: rotating code
    currentCheckInCode: v.optional(v.string()),
    codeGeneratedAt: v.optional(v.number()),
    codeExpiresAt: v.optional(v.number()),

    // Stats (denormalized)
    attendeeCount: v.number(),

    createdBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_scheduledDate", ["scheduledDate"])
    .index("by_checkInStatus", ["checkInStatus"])
    .index("by_createdAt", ["createdAt"]),

  attendanceRecords: defineTable({
    meetingId: v.id("meetings"),
    studentId: v.id("users"),
    profileId: v.id("profiles"),

    // Verification details
    checkInTimestamp: v.number(),
    verificationMethod: v.union(
      v.literal("rotating_code"),
      v.literal("manual_admin"),
      v.literal("retroactive")
    ),
    codeUsed: v.optional(v.string()),

    // Status
    status: v.union(
      v.literal("present"),
      v.literal("excused"),
      v.literal("invalidated")
    ),

    // Admin override
    manuallyVerifiedBy: v.optional(v.id("users")),
    notes: v.optional(v.string()),

    // Device fingerprint (lightweight, not for tracking)
    deviceHash: v.optional(v.string()),

    createdAt: v.number(),
  })
    .index("by_meetingId", ["meetingId"])
    .index("by_studentId", ["studentId"])
    .index("by_meetingId_studentId", ["meetingId", "studentId"])
    .index("by_status", ["status"]),

  // ============ OPPORTUNITIES & CALENDAR ============

  opportunities: defineTable({
    title: v.string(),
    description: v.string(),
    organizationName: v.string(),

    // Details
    location: v.optional(v.string()),
    contactName: v.optional(v.string()),
    contactEmail: v.optional(v.string()),
    contactPhone: v.optional(v.string()),
    externalLink: v.optional(v.string()),

    // Categorization
    tags: v.array(v.string()),
    estimatedHours: v.optional(v.number()),

    // Dates
    startDate: v.optional(v.string()),
    endDate: v.optional(v.string()),
    isOngoing: v.boolean(),

    // Visibility
    isActive: v.boolean(),

    createdBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_isActive", ["isActive"])
    .index("by_tags", ["tags"])
    .index("by_createdAt", ["createdAt"]),

  calendarEvents: defineTable({
    title: v.string(),
    description: v.optional(v.string()),

    eventType: v.union(
      v.literal("meeting"),
      v.literal("service_event"),
      v.literal("deadline"),
      v.literal("other")
    ),

    // Link to related entity
    relatedMeetingId: v.optional(v.id("meetings")),
    relatedOpportunityId: v.optional(v.id("opportunities")),

    // Timing
    eventDate: v.string(),
    startTime: v.optional(v.string()),
    endTime: v.optional(v.string()),
    isAllDay: v.boolean(),

    location: v.optional(v.string()),

    createdBy: v.id("users"),
    createdAt: v.number(),
  })
    .index("by_eventDate", ["eventDate"])
    .index("by_eventType", ["eventType"]),

  // ============ NOTIFICATIONS ============

  notifications: defineTable({
    userId: v.id("users"),

    type: v.union(
      v.literal("submission_received"),
      v.literal("submission_approved"),
      v.literal("submission_denied"),
      v.literal("submission_revision_requested"),
      v.literal("meeting_reminder"),
      v.literal("meeting_checkin_open"),
      v.literal("new_opportunity"),
      v.literal("announcement"),
      v.literal("profile_verified"),
      v.literal("profile_rejected")
    ),

    title: v.string(),
    message: v.string(),

    // Related entities for deep linking
    relatedSubmissionId: v.optional(v.id("serviceSubmissions")),
    relatedMeetingId: v.optional(v.id("meetings")),
    relatedOpportunityId: v.optional(v.id("opportunities")),

    isRead: v.boolean(),
    readAt: v.optional(v.number()),

    // Email tracking
    emailSent: v.boolean(),
    emailSentAt: v.optional(v.number()),

    createdAt: v.number(),
  })
    .index("by_userId", ["userId"])
    .index("by_userId_isRead", ["userId", "isRead"])
    .index("by_createdAt", ["createdAt"]),

  // ============ AUDIT & ADMIN ============

  auditLogs: defineTable({
    actorId: v.id("users"),
    actorRole: v.string(),

    action: v.string(), // e.g., "submission.approved", "meeting.created"
    entityType: v.string(), // "serviceSubmission", "meeting", etc.
    entityId: v.string(), // ID of affected entity

    // Snapshot of changes
    previousValue: v.optional(v.string()), // JSON string
    newValue: v.optional(v.string()),      // JSON string

    // Context
    ipAddress: v.optional(v.string()),
    userAgent: v.optional(v.string()),

    createdAt: v.number(),
  })
    .index("by_actorId", ["actorId"])
    .index("by_entityType_entityId", ["entityType", "entityId"])
    .index("by_action", ["action"])
    .index("by_createdAt", ["createdAt"]),

  announcements: defineTable({
    title: v.string(),
    content: v.string(),

    // Targeting
    targetRoles: v.array(v.string()), // ["student", "officer"] or ["all"]

    // Scheduling
    publishAt: v.number(),
    expiresAt: v.optional(v.number()),

    // Email options
    sendEmail: v.boolean(),
    emailSentAt: v.optional(v.number()),

    createdBy: v.id("users"),
    createdAt: v.number(),
  })
    .index("by_publishAt", ["publishAt"])
    .index("by_createdAt", ["createdAt"]),

  // ============ APP CONFIG ============

  appConfig: defineTable({
    key: v.string(),
    value: v.string(), // JSON string for flexibility
    updatedBy: v.id("users"),
    updatedAt: v.number(),
  })
    .index("by_key", ["key"]),
});
```

### Schema Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Soft delete | Not used | Hard delete with audit log instead; simpler queries |
| Denormalized stats | Yes, on profiles | Dashboard needs instant load; update via mutations |
| Date storage | ISO strings | Timezone-agnostic, easy to display |
| Timestamps | Unix ms | Convex convention, easy math |
| File references | `_storage` IDs | Native Convex storage integration |
| JSON in audit logs | String field | Flexible schema for varying entities |

### Indexes Rationale

- **by_email**: User lookup during auth
- **by_studentId_status**: Student's filtered submission list
- **by_meetingId_studentId**: Prevent duplicate attendance (unique check)
- **by_userId_isRead**: Unread notification count badge
- **by_createdAt**: Pagination and sorting

---

## 5. Convex Function List

### Queries

#### User & Profile

```typescript
// users.ts

getMe()
// Auth: authenticated
// Returns: { user, profile, unreadNotificationCount }
// Failure: throws if not authenticated

getProfile({ userId })
// Auth: self or admin
// Input: userId: Id<"users">
// Returns: Profile with user info
// Failure: 404 if not found, 403 if unauthorized

listStudents({ status?, grade?, search?, cursor? })
// Auth: admin only
// Input: filters and pagination
// Returns: { students: Profile[], nextCursor }
// Failure: 403 if not admin
```

#### Service Submissions

```typescript
// serviceHours.ts

getSubmission({ submissionId })
// Auth: owner or admin
// Input: submissionId: Id<"serviceSubmissions">
// Returns: Full submission with evidence URL
// Failure: 404, 403

listMySubmissions({ status?, cursor? })
// Auth: authenticated student
// Returns: { submissions[], nextCursor, totalHours }

listPendingSubmissions({ cursor?, studentId?, dateRange? })
// Auth: admin only
// Returns: { submissions[], nextCursor, totalCount }

getSubmissionStats()
// Auth: admin only
// Returns: { pending, approvedThisMonth, deniedThisMonth }
```

#### Attendance

```typescript
// attendance.ts

getMeeting({ meetingId })
// Auth: authenticated
// Returns: Meeting with attendee count

listMeetings({ upcoming?, past?, cursor? })
// Auth: authenticated
// Returns: { meetings[], nextCursor }

getMyAttendance({ meetingId })
// Auth: authenticated student
// Returns: AttendanceRecord | null

getMeetingAttendance({ meetingId })
// Auth: admin only
// Returns: { records[], presentCount, totalStudents }

getAttendanceStats({ studentId? })
// Auth: self or admin
// Returns: { attended, total, percentage }
```

#### Calendar & Opportunities

```typescript
// calendar.ts

getCalendarEvents({ month, year })
// Auth: authenticated
// Returns: Events for month (meetings + calendar events)

// opportunities.ts

listOpportunities({ tags?, isOngoing?, cursor? })
// Auth: authenticated
// Returns: { opportunities[], nextCursor }

getOpportunity({ opportunityId })
// Auth: authenticated
// Returns: Full opportunity details
```

#### Notifications

```typescript
// notifications.ts

listNotifications({ unreadOnly?, cursor? })
// Auth: authenticated
// Returns: { notifications[], nextCursor, unreadCount }
```

#### Admin

```typescript
// admin.ts

getAdminDashboard()
// Auth: admin only
// Returns: {
//   pendingSubmissions: number,
//   pendingProfiles: number,
//   upcomingMeetings: Meeting[],
//   recentActivity: AuditLog[]
// }

getAuditLogs({ entityType?, entityId?, actorId?, cursor? })
// Auth: admin only
// Returns: { logs[], nextCursor }
```

---

### Mutations

#### User & Profile

```typescript
createProfile({ firstName, lastName, grade, studentId? })
// Auth: authenticated, no existing profile
// Validation: name 1-50 chars, grade 9-12
// Effects: Creates profile with status "pending", creates notification for admins
// Returns: profileId
// Failure: 400 if profile exists, validation errors

updateProfile({ firstName?, lastName?, grade?, studentId? })
// Auth: authenticated with profile
// Validation: same as create
// Effects: If verified, logs change in audit; may reset verification if name changed
// Returns: void
// Failure: 404, validation errors

verifyProfile({ profileId, approve, rejectionReason? })
// Auth: admin only
// Effects: Updates status, creates notification, logs audit
// Returns: void
// Failure: 404, 400 if already processed
```

#### Service Submissions

```typescript
submitServiceHours({
  organizationName,
  serviceDate,
  startTime,
  endTime,
  description,
  supervisorName,
  supervisorEmail,
  supervisorPhone?,
  evidenceFileId?
})
// Auth: verified student only
// Validation:
//   - date not in future
//   - hours 0.25-12
//   - description 10-1000 chars
//   - valid email format
// Effects: Creates submission, updates profile.totalPendingHours, notifies admins
// Returns: submissionId
// Failure: 403 if not verified, validation errors

updateSubmission({ submissionId, ...fields })
// Auth: owner, status must be "pending" or "revision_requested"
// Returns: void
// Failure: 403 if wrong status

reviewSubmission({ submissionId, decision, notes? })
// Auth: admin only
// Input: decision: "approved" | "denied" | "revision_requested"
// Effects:
//   - Updates submission status
//   - If approved: updates profile.totalApprovedHours, decrements pendingHours
//   - Creates notification for student
//   - Logs audit
// Returns: void
// Failure: 404, 400 if already final

deleteSubmission({ submissionId })
// Auth: owner, status must be "pending"
// Effects: Hard delete, update pendingHours, log audit
// Returns: void
```

#### Attendance

```typescript
createMeeting({
  title,
  description?,
  location,
  scheduledDate,
  scheduledStartTime,
  scheduledEndTime
})
// Auth: admin only
// Effects: Creates meeting, creates calendar event
// Returns: meetingId

updateMeeting({ meetingId, ...fields })
// Auth: admin only
// Returns: void

openCheckIn({ meetingId })
// Auth: admin only
// Effects:
//   - Sets checkInStatus to "open"
//   - Generates first rotating code (6 alphanumeric, expires in 60s)
//   - Creates notification for all students
// Returns: { code, expiresAt }

refreshCheckInCode({ meetingId })
// Auth: admin only (or automated)
// Effects: Generates new code, invalidates old
// Returns: { code, expiresAt }

closeCheckIn({ meetingId })
// Auth: admin only
// Effects: Sets status to "closed", clears code
// Returns: void

checkIn({ meetingId, code })
// Auth: verified student only
// Validation:
//   - Meeting check-in is open
//   - Code matches current code
//   - Code not expired
//   - Student hasn't already checked in
// Effects:
//   - Creates attendance record
//   - Increments meeting.attendeeCount
//   - Increments profile.meetingsAttended
//   - Generates device hash from user-agent (collision detection only)
// Returns: { success: true }
// Failure:
//   - 400 "Check-in not open"
//   - 400 "Invalid or expired code"
//   - 400 "Already checked in"

manualCheckIn({ meetingId, studentId, status, notes? })
// Auth: admin only
// Effects: Creates/updates attendance record with "manual_admin" method
// Returns: void

updateAttendanceStatus({ recordId, status, notes? })
// Auth: admin only
// Effects: Updates record, logs audit
// Returns: void
```

#### Opportunities

```typescript
createOpportunity({ ...fields })
// Auth: admin or officer
// Returns: opportunityId

updateOpportunity({ opportunityId, ...fields })
// Auth: admin or officer
// Returns: void

archiveOpportunity({ opportunityId })
// Auth: admin or officer
// Effects: Sets isActive to false
// Returns: void
```

#### Notifications

```typescript
markNotificationRead({ notificationId })
// Auth: owner only
// Returns: void

markAllNotificationsRead()
// Auth: authenticated
// Returns: { count }
```

#### Admin

```typescript
sendAnnouncement({ title, content, targetRoles, sendEmail })
// Auth: admin only
// Effects:
//   - Creates announcement
//   - Creates notifications for targeted users
//   - If sendEmail, schedules email action
// Returns: announcementId

bulkImportStudents({ csvData })
// Auth: admin only
// Input: CSV string with columns: email, firstName, lastName, grade
// Effects: Creates users with "pending" profiles (no password yet)
// Returns: { imported: number, errors: string[] }
```

---

### Actions (with side effects)

```typescript
// actions/email.ts

sendEmail({ to, subject, templateId, data })
// Calls Resend API
// Templates: welcome, submission_status, meeting_reminder, announcement

sendBulkEmail({ recipients, subject, templateId, data })
// Batched Resend calls

// actions/scheduled.ts

generateMeetingReminders()
// Cron: daily at 8am
// Finds meetings tomorrow, creates notifications + emails

expireOldCodes()
// Cron: every minute
// Clears expired check-in codes

sendDailyDigest()
// Cron: daily at 6pm
// Sends digest of day's activity to admins

cleanupOldAuditLogs()
// Cron: monthly
// Archives logs older than 4 years
```

---

## 6. Auth & RBAC Rules

### Role Definitions

| Role | Description | Permissions |
|------|-------------|-------------|
| `student` | Standard NHS member | Submit hours, check-in, view own data, browse opportunities |
| `officer` | Student leader | All student perms + manage opportunities, view (not approve) submissions |
| `admin` | Teacher/Sponsor | Full access: verify profiles, approve submissions, manage meetings, send announcements |

### Permission Matrix

| Action | student | officer | admin |
|--------|---------|---------|-------|
| Create profile | Y | Y | Y |
| Submit service hours | Y* | Y* | - |
| View own submissions | Y | Y | Y |
| View all submissions | - | read | Y |
| Approve/deny submissions | - | - | Y |
| Check-in to meeting | Y* | Y* | - |
| Create meeting | - | - | Y |
| Open/close check-in | - | - | Y |
| Manual attendance edit | - | - | Y |
| Create opportunity | - | Y | Y |
| Verify student profiles | - | - | Y |
| Send announcements | - | - | Y |
| View audit logs | - | - | Y |
| Export data | - | - | Y |

*Requires verified profile

### Implementation Pattern

```typescript
// convex/lib/permissions.ts

import { QueryCtx, MutationCtx } from "../_generated/server";

export async function requireAuth(ctx: QueryCtx | MutationCtx) {
  const identity = await ctx.auth.getUserIdentity();
  if (!identity) throw new Error("Unauthorized");

  const user = await ctx.db
    .query("users")
    .withIndex("by_email", (q) => q.eq("email", identity.email))
    .unique();

  if (!user) throw new Error("User not found");
  return user;
}

export async function requireRole(
  ctx: QueryCtx | MutationCtx,
  roles: ("student" | "officer" | "admin")[]
) {
  const user = await requireAuth(ctx);
  if (!roles.includes(user.role)) {
    throw new Error("Forbidden: insufficient permissions");
  }
  return user;
}

export async function requireVerifiedStudent(ctx: QueryCtx | MutationCtx) {
  const user = await requireAuth(ctx);
  if (user.role === "admin") return user; // Admins don't need verification

  const profile = await ctx.db.get(user.profileId);
  if (!profile || profile.verificationStatus !== "verified") {
    throw new Error("Profile must be verified to perform this action");
  }
  return user;
}

export async function requireOwnerOrAdmin(
  ctx: QueryCtx | MutationCtx,
  ownerId: Id<"users">
) {
  const user = await requireAuth(ctx);
  if (user._id !== ownerId && user.role !== "admin") {
    throw new Error("Forbidden: not owner or admin");
  }
  return user;
}
```

### File Access Control

```typescript
// Evidence files: only owner + admins can access
// Implemented via Convex HTTP endpoint that checks auth before serving

// convex/http.ts
import { httpRouter } from "convex/server";
import { httpAction } from "./_generated/server";

const http = httpRouter();

http.route({
  path: "/evidence/{storageId}",
  method: "GET",
  handler: httpAction(async (ctx, request) => {
    const { storageId } = request.params;

    // Verify auth token from cookie/header
    const user = await verifyAuthToken(ctx, request);
    if (!user) return new Response("Unauthorized", { status: 401 });

    // Find submission with this evidence
    const submission = await ctx.runQuery(
      internal.serviceHours.getSubmissionByEvidence,
      { storageId }
    );

    if (!submission) return new Response("Not found", { status: 404 });

    // Check access
    if (submission.studentId !== user._id && user.role !== "admin") {
      return new Response("Forbidden", { status: 403 });
    }

    // Serve file
    const blob = await ctx.storage.get(storageId);
    return new Response(blob);
  }),
});
```

### Rate Limiting

```typescript
// Check-in rate limiting (in-memory, resets on deploy)
const checkInAttempts = new Map<string, { count: number; resetAt: number }>();

export function rateLimit(userId: string, limit: number, windowMs: number) {
  const key = userId;
  const now = Date.now();
  const record = checkInAttempts.get(key);

  if (!record || record.resetAt < now) {
    checkInAttempts.set(key, { count: 1, resetAt: now + windowMs });
    return true;
  }

  if (record.count >= limit) {
    throw new Error("Rate limited: too many attempts");
  }

  record.count++;
  return true;
}

// Usage in checkIn mutation:
rateLimit(user._id, 5, 60000); // 5 attempts per minute
```

### Audit Logging Strategy

**Events to log:**
- Profile verification/rejection
- Submission approval/denial
- Attendance manual overrides
- Role changes
- Meeting creation/deletion
- Announcement sends
- Bulk imports
- Any admin action on student data

**Not logged (too noisy):**
- Read queries
- Notification reads
- Student's own pending submission edits

---

## 7. Attendance Verification Design

### Options Evaluated

| Option | Pros | Cons | Feasibility |
|--------|------|------|-------------|
| **A. Rotating Codes** | Simple, works everywhere, no device APIs | Can be shared quickly via text | High |
| **B. Geo-fence** | Strong location proof | Requires GPS permission, battery drain, indoor GPS unreliable | Medium |
| **C. Bluetooth beacon** | Proximity proof | Requires hardware, pairing complexity | Low |
| **D. Teacher device tap (NFC)** | Very strong proof | Requires NFC phones, physical queue | Low |
| **E. Device binding** | Prevents device sharing | Students share phones, privacy concerns | Low |
| **F. Time-limited session token** | Reduces sharing window | Still shareable within window | High |

### Recommended Approach: Rotating Codes + Time Pressure

**Primary Method: Rotating 6-Character Codes**

```
Code: ABC123
Rotates every: 30-60 seconds (configurable)
Display: Large on admin's screen or projector
Entry: Student types code in app
```

**Why this works for schools:**
1. **No special hardware** - Admin shows code on phone/laptop
2. **No permissions needed** - No GPS, Bluetooth, camera
3. **Time pressure** - 30-60s window makes text-sharing impractical
4. **Visual confirmation** - Admin sees who's looking at their screen
5. **Works indoors** - No GPS reliability issues

**Anti-Sharing Enhancements:**

1. **Short rotation window (30s default)**
   - By the time you text a friend, code is expired
   - Admin can adjust based on meeting size

2. **Device hash logging (not blocking)**
   - Hash user-agent string
   - Flag if same device hash used by multiple students
   - Admin reviews flags, doesn't auto-block

3. **Check-in analytics dashboard**
   - Show check-in time distribution
   - Outliers (very fast, very slow) flagged
   - Admin can investigate patterns

4. **Single active session**
   - If student logs in on new device, old session invalidates
   - Prevents "I'll log in for you" scenarios

**Why NOT rely on IP:**
- School WiFi: all students share same public IP
- Mobile data: carrier-grade NAT means shared IPs
- VPNs: trivial to bypass IP checks
- IP is useful for logging, not for blocking

### Attendance Record Schema

```typescript
{
  meetingId: Id<"meetings">,
  studentId: Id<"users">,
  profileId: Id<"profiles">,

  checkInTimestamp: number,
  verificationMethod: "rotating_code" | "manual_admin" | "retroactive",
  codeUsed: string | null, // For audit

  status: "present" | "excused" | "invalidated",

  // Anti-sharing detection (not enforcement)
  deviceHash: string | null,

  // Admin override
  manuallyVerifiedBy: Id<"users"> | null,
  notes: string | null,
}
```

### Admin Check-In Flow

```
1. Admin opens meeting in app
2. Taps "Start Check-In"
3. Large code displays: "ABC123" with countdown timer
4. Code auto-rotates every 30s (configurable)
5. Admin can project screen or show phone
6. Students enter code on their phones
7. Real-time attendee count updates
8. Admin taps "End Check-In" when done
9. Can manually add stragglers
```

### Student Check-In Flow

```
1. Student receives push notification "Check-in open for [Meeting]"
2. Opens app -> Check-In screen
3. Enters 6-character code
4. If valid: "You're checked in!" confirmation
5. If expired: "Code expired, try current code"
6. If already checked in: "Already recorded"
```

### Fallback: Manual Check-In

For edge cases (phone died, forgot phone, technical issues):
- Admin has "Manual Add" button
- Selects student from roster
- Marks as "manual_admin" verification method
- Must add a note explaining why

---

## 8. UI Screen Map & Components

### Design Reference
Based on Air.inc-style layout with fixed left sidebar and main content area.

### Design Foundation

**Color Palette:**
```css
:root {
  /* Primary - NHS Blue (gradient-capable) */
  --primary-900: #1e3a5f;  /* Deep navy - gradient start */
  --primary-700: #1d4ed8;  /* Strong blue */
  --primary-600: #2563eb;  /* Main brand */
  --primary-500: #3b82f6;  /* Standard blue */
  --primary-400: #60a5fa;  /* Light blue */
  --primary-200: #bfdbfe;  /* Very light - gradient end */
  --primary-50: #eff6ff;   /* Background tint */

  /* Landing page gradient */
  --gradient-hero: linear-gradient(180deg, #1e3a5f 0%, #3b82f6 50%, #93c5fd 100%);

  /* Success - Approval green */
  --success-500: #22c55e;
  --success-50: #f0fdf4;

  /* Warning - Pending yellow */
  --warning-500: #eab308;
  --warning-50: #fefce8;

  /* Error - Denial red */
  --error-500: #ef4444;
  --error-50: #fef2f2;

  /* Neutral - Sidebar & UI */
  --gray-50: #f9fafb;   /* Main content bg */
  --gray-100: #f3f4f6;  /* Sidebar bg */
  --gray-200: #e5e7eb;  /* Borders */
  --gray-400: #9ca3af;  /* Muted text */
  --gray-500: #6b7280;  /* Secondary text */
  --gray-700: #374151;  /* Primary text */
  --gray-900: #111827;  /* Headings */
}
```

**Typography:**
```css
/* Primary: Inter (clean, modern, excellent readability) */
font-family: 'Inter', system-ui, sans-serif;

/* Landing page hero: serif accent for "seamlessly" style emphasis */
/* Use italic or a display font for key words */

/* Scale */
--text-xs: 0.75rem;    /* 12px - labels, sidebar items */
--text-sm: 0.875rem;   /* 14px - secondary, nav items */
--text-base: 1rem;     /* 16px - body */
--text-lg: 1.125rem;   /* 18px - large body */
--text-xl: 1.25rem;    /* 20px - section headers */
--text-2xl: 1.5rem;    /* 24px - page titles */
--text-3xl: 1.875rem;  /* 30px - dashboard headers */
--text-4xl: 2.25rem;   /* 36px - landing hero */
--text-5xl: 3rem;      /* 48px - landing hero large */
```

**Component Patterns:**
- Cards: rounded-xl, shadow-sm, white bg, hover:shadow-md transition
- Buttons: rounded-lg, py-2.5 px-4, font-medium
- Inputs: rounded-lg, border-gray-200, focus:ring-2 focus:ring-primary-500
- Status badges: rounded-full, px-2.5 py-0.5, text-xs font-medium
- Sidebar items: rounded-lg, px-3 py-2, hover:bg-gray-200

---

### Desktop Layout Structure (Air.inc Style)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                â”‚  [Search NHS Companion...]     [Notifications] [+Add]â”‚ â”‚
â”‚ â”‚   NHS          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚ â”‚   Companion    â”‚                                                     â”‚ â”‚
â”‚ â”‚                â”‚  ğŸ“ Dashboard                                       â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                                     â”‚ â”‚
â”‚ â”‚                â”‚  Welcome back, Sarah!                               â”‚ â”‚
â”‚ â”‚ â—‹ Dashboard    â”‚                                                     â”‚ â”‚
â”‚ â”‚ â—‹ Submit Hours â”‚  [Stats Cards Grid]                                 â”‚ â”‚
â”‚ â”‚ â—‹ My Submiss.. â”‚                                                     â”‚ â”‚
â”‚ â”‚ â—‹ Check-In     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚ â—‹ Calendar     â”‚  â”‚ 24 hrs  â”‚ â”‚ 3.5 hrs â”‚ â”‚ 5 mtgs  â”‚ â”‚ 2 pend  â”‚   â”‚ â”‚
â”‚ â”‚ â—‹ Opportunit.. â”‚  â”‚Approved â”‚ â”‚ Pending â”‚ â”‚Attended â”‚ â”‚ Review  â”‚   â”‚ â”‚
â”‚ â”‚                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                                     â”‚ â”‚
â”‚ â”‚                â”‚  Upcoming Events                                    â”‚ â”‚
â”‚ â”‚ Quick Filters â–¼â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚ â”‚  â—‹ Pending     â”‚  â”‚ Meeting card                                 â”‚  â”‚ â”‚
â”‚ â”‚  â—‹ This Month  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚ â”‚  â—‹ Upcoming    â”‚                                                     â”‚ â”‚
â”‚ â”‚                â”‚  Recent Submissions                                 â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚ â”‚                â”‚  â”‚ Submission card                              â”‚  â”‚ â”‚
â”‚ â”‚ [+ New Filter] â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚ â”‚                â”‚                                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Sidebar Dimensions:**
- Width: 240px (fixed)
- Collapsible to 64px (icons only) on smaller screens
- Background: gray-100
- Border-right: 1px solid gray-200

**Main Content Area:**
- Background: gray-50 or white
- Header bar height: 56px
- Padding: 24px

---

### Landing Page Design (Simple Hero)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚                         NHS Companion                                    â”‚
â”‚                                                                          â”‚
â”‚                   [Login]        [Get Started]                          â”‚
â”‚                                                                          â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                          â”‚
â”‚                  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘                         â”‚
â”‚                â–‘â–‘â–‘â–‘ BACKGROUND IMAGE: hero-bg.jpg â–‘â–‘â–‘â–‘                   â”‚
â”‚               â–‘â–‘â–‘â–‘ Soft sky blue gradient with light â–‘â–‘â–‘â–‘                â”‚
â”‚                â–‘â–‘â–‘â–‘ vertical streaks, ethereal feel â–‘â–‘â–‘â–‘                 â”‚
â”‚                  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘                         â”‚
â”‚                                                                          â”‚
â”‚              Track your service. Make an impact.                        â”‚
â”‚                                                                          â”‚
â”‚           The easiest way to log community service hours,               â”‚
â”‚            verify meeting attendance, and stay connected                â”‚
â”‚                    with your NHS chapter.                               â”‚
â”‚                                                                          â”‚
â”‚                      [ Get Started ]                                    â”‚
â”‚                                                                          â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Landing Page Background:**
- Use provided image: `public/images/hero-bg.jpg`
- Soft sky blue gradient (deeper at top, fading to near-white at bottom)
- Subtle vertical light streaks for ethereal quality
- Full viewport coverage with `background-size: cover; background-position: center;`

**Landing Page Elements:**
- Full viewport height hero section (`min-h-screen`)
- Background image (NOT CSS gradient) - provided image file
- Centered logo/wordmark at top (white or dark depending on contrast)
- Minimal navigation: Login | Get Started (buttons with slight transparency/glass effect)
- Hero headline with emphasis on key word (italic or different weight)
- White text for headline/subtext (good contrast on blue bg)
- Subtext explaining value prop
- Single prominent CTA button (white bg, blue text)
- No additional sections (simple redirect to auth)

**Text Colors on Landing:**
- Headlines: white (`#ffffff`)
- Subtext: white with slight opacity (`rgba(255,255,255,0.9)`)
- Buttons: Glass effect with white border, or solid white with blue text

---

### Role-Based Sidebar Navigation

#### Student Sidebar
```
NHS Companion (Logo)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Navigation
  â—‹ Dashboard
  â—‹ Submit Hours
  â—‹ My Submissions
  â—‹ Check-In
  â—‹ Calendar
  â—‹ Opportunities
  â—‹ Notifications (badge)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Quick Filters â–¼
  â—‹ Pending Submissions
  â—‹ This Month's Hours
  â—‹ Upcoming Meetings
  + Add Filter
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Profile (bottom)
  [Avatar] Sarah Johnson
  Settings | Logout
```

#### Admin Sidebar
```
NHS Companion (Logo)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Navigation
  â—‹ Dashboard
  â—‹ Review Queue (badge)
  â—‹ Students
  â—‹ Meetings
  â—‹ Opportunities
  â—‹ Announcements
  â—‹ Exports
  â—‹ Notifications (badge)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Quick Filters â–¼
  â—‹ Pending Approvals
  â—‹ Unverified Students
  â—‹ Today's Meetings
  â—‹ Recent Activity
  + Add Filter
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Profile (bottom)
  [Avatar] Mrs. Johnson
  Settings | Logout
```

---

### Screen Map

#### Public Screens
- `/` - Landing page (gradient hero + CTA)
- `/login` - Email/password + magic link option
- `/signup` - Registration with confirm password
- `/verify-email` - Email verification pending screen

#### Student Screens (with sidebar)
- `/dashboard` - Hours summary, stats cards, upcoming events, recent activity
- `/submit-hours` - Service hours submission form (modal or page)
- `/submissions` - Submission history with filters (card grid or list)
- `/submissions/[id]` - Submission detail view (right panel or full page)
- `/check-in` - Meeting check-in with code entry
- `/check-in/[meetingId]` - Direct link to specific meeting check-in
- `/calendar` - Month view calendar with events
- `/opportunities` - Browse service opportunities (card grid)
- `/opportunities/[id]` - Opportunity detail
- `/notifications` - Notification center (list view)
- `/profile` - Profile management and settings

#### Admin Screens (with sidebar)
- `/admin/dashboard` - Pending counts, stats, recent activity feed
- `/admin/review` - Submissions review queue (table or cards)
- `/admin/review/[id]` - Review detail with approve/deny actions
- `/admin/students` - Student roster, verification queue
- `/admin/students/[id]` - Student detail (hours, attendance, history)
- `/admin/meetings` - Meetings list and management
- `/admin/meetings/new` - Create meeting form
- `/admin/meetings/[id]` - Meeting detail with check-in control
- `/admin/opportunities` - Opportunity management
- `/admin/opportunities/new` - Create opportunity form
- `/admin/announcements` - Send announcements
- `/admin/exports` - CSV export tools

---

### Key Components to Build

#### Layout Components
| Component | Location | Purpose |
|-----------|----------|---------|
| `AppShell` | layout/ | Main wrapper with sidebar + content area |
| `Sidebar` | layout/ | Fixed left sidebar (role-aware) |
| `SidebarNav` | layout/ | Navigation items with icons |
| `SidebarSection` | layout/ | Collapsible section (Quick Filters) |
| `TopBar` | layout/ | Search bar + notifications + actions |
| `UserMenu` | layout/ | Profile dropdown at sidebar bottom |
| `MobileNav` | layout/ | Bottom tab bar for mobile (replaces sidebar) |

#### Shared Components
| Component | Location | Purpose |
|-----------|----------|---------|
| `StatusBadge` | shared/ | Pending/Approved/Denied pills |
| `FileUpload` | shared/ | Drag-drop + click, preview, progress |
| `Calendar` | shared/ | Month view with event dots |
| `NotificationBell` | shared/ | Unread count badge (header) |
| `NotificationBadge` | shared/ | Small count badge for sidebar items |
| `SearchInput` | shared/ | Global search in top bar |
| `StatsCard` | shared/ | Metric card (number + label) |
| `EmptyState` | shared/ | Empty list/grid placeholder |
| `LoadingState` | shared/ | Skeleton loaders |

#### Card Components
| Component | Location | Purpose |
|-----------|----------|---------|
| `SubmissionCard` | cards/ | Submission preview (grid or list item) |
| `MeetingCard` | cards/ | Meeting preview with date/time |
| `OpportunityCard` | cards/ | Opportunity preview with tags |
| `ActivityCard` | cards/ | Recent activity feed item |
| `QuickFilterCard` | cards/ | Saved filter in sidebar |

#### Form Components
| Component | Location | Purpose |
|-----------|----------|---------|
| `ServiceHoursForm` | forms/ | Multi-step submission form |
| `MeetingForm` | forms/ | Create/edit meeting |
| `OpportunityForm` | forms/ | Create/edit opportunity |
| `ProfileForm` | forms/ | Student profile creation/edit |
| `AnnouncementForm` | forms/ | Send announcement |

#### Feature-Specific Components
| Component | Location | Purpose |
|-----------|----------|---------|
| `CheckInCodeDisplay` | features/checkin/ | Large rotating code with timer (admin) |
| `CheckInInput` | features/checkin/ | 6-character code entry (student) |
| `ReviewActions` | features/review/ | Approve/Deny/Revision buttons |
| `SubmissionTimeline` | features/submissions/ | Status history timeline |
| `AttendanceList` | features/attendance/ | Meeting attendee list |

#### Landing Page Components
| Component | Location | Purpose |
|-----------|----------|---------|
| `LandingNav` | landing/ | Minimal nav (Login + Get Started) |
| `HeroSection` | landing/ | Gradient hero with CTA |

---

## 9. Milestones & Checklist

### Milestone 1: Foundation
**Objective:** Project setup with auth and basic navigation

**Files/Modules:**
- `package.json`, `tailwind.config.ts`, `convex.json`
- `convex/schema.ts` (initial tables: users, profiles)
- `convex/auth.ts` (Convex Auth config)
- `src/app/layout.tsx`, `src/app/(auth)/*`
- `src/components/ui/*` (shadcn setup)

**Acceptance Criteria:**
- [ ] Next.js app runs locally
- [ ] Convex connected and syncing
- [ ] User can sign up with email/password
- [ ] User can sign in and see empty dashboard
- [ ] Magic link auth works
- [ ] Protected routes redirect to login

**Complexity:** Medium

---

### Milestone 2: Profile & Verification
**Objective:** Students create profiles; admins verify

**Files/Modules:**
- `convex/functions/users.ts`
- `src/app/(student)/profile/*`
- `src/app/(admin)/students/*`

**Acceptance Criteria:**
- [ ] New user must create profile after first login
- [ ] Profile form validates inputs
- [ ] Admin sees list of pending profiles
- [ ] Admin can verify/reject with reason
- [ ] Student sees verification status
- [ ] Unverified students blocked from submitting hours

**Complexity:** Medium

---

### Milestone 3: Service Hours Submission
**Objective:** Core hours submission workflow

**Files/Modules:**
- `convex/functions/serviceHours.ts`
- `convex/schema.ts` (serviceSubmissions table)
- `src/app/(student)/submit-hours/*`
- `src/app/(student)/submissions/*`
- `src/components/forms/ServiceHoursForm.tsx`
- `src/components/shared/FileUpload.tsx`

**Acceptance Criteria:**
- [ ] Student can submit hours with all required fields
- [ ] File upload works (Convex storage)
- [ ] Validation: hours 0.25-12, date not future, etc.
- [ ] Student sees submission history with statuses
- [ ] Student can view submission details
- [ ] Student can edit pending submissions
- [ ] Profile stats update (pending hours)

**Complexity:** Large

---

### Milestone 4: Admin Review Workflow
**Objective:** Admins approve/deny submissions

**Files/Modules:**
- `convex/functions/admin.ts`
- `src/app/(admin)/submissions/*`
- `src/app/(admin)/dashboard/*`

**Acceptance Criteria:**
- [ ] Admin sees pending submissions queue
- [ ] Admin can filter by student, date, status
- [ ] Admin can view full submission + evidence
- [ ] Admin can approve with optional note
- [ ] Admin can deny with required note
- [ ] Admin can request revision
- [ ] Student notified of decision
- [ ] Profile stats update (approved hours)
- [ ] Audit log created

**Complexity:** Large

---

### Milestone 5: Meetings & Attendance
**Objective:** Meeting creation and check-in system

**Files/Modules:**
- `convex/functions/attendance.ts`
- `convex/schema.ts` (meetings, attendanceRecords)
- `src/app/(admin)/meetings/*`
- `src/app/(student)/check-in/*`
- `src/components/admin/CheckInCodeDisplay.tsx`

**Acceptance Criteria:**
- [ ] Admin can create/edit meetings
- [ ] Admin can open check-in (generates code)
- [ ] Code rotates every 30-60 seconds
- [ ] Student can enter code to check in
- [ ] Invalid/expired codes rejected
- [ ] Duplicate check-ins prevented
- [ ] Admin sees real-time attendee count
- [ ] Admin can manually add students
- [ ] Admin can close check-in
- [ ] Device hash logged for review

**Complexity:** Large

---

### Milestone 6: Notifications
**Objective:** In-app notification system

**Files/Modules:**
- `convex/functions/notifications.ts`
- `convex/schema.ts` (notifications)
- `src/app/(student)/notifications/*`
- `src/components/shared/NotificationBell.tsx`

**Acceptance Criteria:**
- [ ] Notifications created on key events
- [ ] User sees unread count in nav
- [ ] Notifications list with read/unread states
- [ ] Tap notification goes to related content
- [ ] Mark single as read
- [ ] Mark all as read

**Complexity:** Medium

---

### Milestone 7: Calendar & Opportunities
**Objective:** Calendar view and opportunity browsing

**Files/Modules:**
- `convex/functions/calendar.ts`
- `convex/functions/opportunities.ts`
- `convex/schema.ts` (opportunities, calendarEvents)
- `src/app/(student)/calendar/*`
- `src/app/(student)/opportunities/*`
- `src/app/(admin)/opportunities/*`

**Acceptance Criteria:**
- [ ] Calendar shows meetings and events
- [ ] Tap date shows that day's events
- [ ] Opportunities list with filters/tags
- [ ] Opportunity detail page
- [ ] Admin can create/edit opportunities
- [ ] Admin can archive opportunities
- [ ] New opportunity creates notifications

**Complexity:** Medium

---

### Milestone 8: Email Notifications
**Objective:** Send emails for key events

**Files/Modules:**
- `convex/actions/email.ts`
- Email templates (in Resend or hardcoded)

**Acceptance Criteria:**
- [ ] Email on submission approved/denied
- [ ] Email on profile verified/rejected
- [ ] Email on meeting reminder (day before)
- [ ] Email on announcements (opt-in)
- [ ] Emails tracked in notification record
- [ ] Unsubscribe/preferences (future)

**Complexity:** Medium

---

### Milestone 9: Admin Enhancements
**Objective:** Exports, announcements, polish

**Files/Modules:**
- `convex/functions/admin.ts` (exports)
- `src/app/(admin)/exports/*`
- `src/app/(admin)/announcements/*`

**Acceptance Criteria:**
- [ ] Admin can send announcements
- [ ] Announcements create notifications + optional email
- [ ] Export attendance to CSV
- [ ] Export service hours to CSV
- [ ] Export filtered by date range
- [ ] Audit log viewer for admins

**Complexity:** Medium

---

### Milestone 10: Polish & QA
**Objective:** Bug fixes, performance, final QA

**Files/Modules:**
- All files (review & refactor)

**Acceptance Criteria:**
- [ ] Mobile responsive on all screens
- [ ] Loading states everywhere
- [ ] Error handling with user-friendly messages
- [ ] Empty states designed
- [ ] Performance: dashboard loads <1s
- [ ] Security review completed
- [ ] Manual QA checklist passed
- [ ] Teacher/sponsor demo successful

**Complexity:** Medium

---

## 10. Testing & QA

### Unit Tests

**Key Logic to Test:**
```typescript
// Hours calculation
test("calculates hours correctly", () => {
  expect(calculateHours("09:00", "12:00")).toBe(3.0);
  expect(calculateHours("09:00", "09:15")).toBe(0.25);
  expect(calculateHours("09:00", "09:10")).toBe(0.25); // rounds up
});

// Permission checks
test("student cannot access admin routes", async () => {
  const student = createMockUser({ role: "student" });
  await expect(requireRole(mockCtx(student), ["admin"]))
    .rejects.toThrow("Forbidden");
});

// Code validation
test("check-in code validates correctly", () => {
  expect(validateCode("ABC123", "ABC123", Date.now())).toBe(true);
  expect(validateCode("ABC123", "XYZ789", Date.now())).toBe(false);
  expect(validateCode("ABC123", "ABC123", Date.now() - 60001)).toBe(false); // expired
});
```

### Integration Tests

**Critical Flows:**
1. **Submission Flow**
   - Create profile -> Submit hours -> Admin approves -> Stats update

2. **Attendance Flow**
   - Create meeting -> Open check-in -> Student checks in -> Verify record

3. **Notification Flow**
   - Event occurs -> Notification created -> Email sent -> Marked read

### Manual QA Checklist

**Pre-Demo Checklist:**
- [ ] Fresh user can sign up and create profile
- [ ] Admin can verify new user
- [ ] Student can submit hours with photo proof
- [ ] Admin can review and approve submission
- [ ] Student sees updated hour count
- [ ] Admin can create meeting for today
- [ ] Admin can open check-in and see code
- [ ] Student can check in with code
- [ ] Code rotation works (wait 30s)
- [ ] Invalid codes are rejected
- [ ] All notifications appear correctly
- [ ] Calendar shows upcoming meetings
- [ ] Mobile view works on iPhone/Android
- [ ] No console errors in production build

### Security Test Checklist

- [ ] **Role bypass**: Student cannot access `/admin/*` routes
- [ ] **Direct API**: Student cannot call admin mutations via Convex
- [ ] **IDOR**: Student cannot view other students' submissions
- [ ] **File access**: Student cannot access other students' evidence files
- [ ] **Check-in abuse**: Rate limiting prevents code brute-force
- [ ] **XSS**: User input sanitized in all displays
- [ ] **Session**: Logout actually invalidates session

---

## 11. Open Questions

1. **School email requirement?**
   Should sign-up be restricted to school email domains (e.g., `@myschool.edu`)? This provides built-in verification but may exclude students who prefer personal email.
   *Default assumption: No restriction, use admin verification instead*

2. **Officer role - include or defer?**
   The Officer role (student leaders who can manage opportunities but not approve hours) adds complexity. Should we include it in MVP or add later?
   *Default assumption: Include but keep simple - same as admin minus approval rights*

3. **Service hour minimums?**
   Should the system track/enforce NHS service hour requirements (e.g., "10 hours per semester")? This requires deadline and goal tracking.
   *Default assumption: Defer to post-MVP; just track total for now*

4. **Supervisor verification?**
   Should the system email supervisors to verify hours automatically? This is more robust but adds complexity and potential delays.
   *Default assumption: No, rely on proof photos + admin judgment*

5. **Meeting excused absences?**
   How should excused absences be handled? Pre-approval flow or retroactive admin marking?
   *Default assumption: Admin can mark as "excused" retroactively*

6. **Data retention consent?**
   Do we need explicit consent flows for data retention? FERPA considerations for student data?
   *Default assumption: Add privacy policy, minimal PII, 4-year retention*

7. **Check-in code length and rotation speed?**
   6 characters rotating every 30 seconds is the default. Should this be admin-configurable?
   *Default assumption: Hardcode defaults, make configurable in v2*

8. **Bulk import format?**
   What format for bulk student import? CSV with specific columns? Integration with school roster export?
   *Default assumption: Simple CSV: email, firstName, lastName, grade*

---

## Summary

This planning pack covers:
- **13 core requirements** prioritized P0-P2
- **10 database tables** with indexes for performance
- **~30 Convex functions** (queries, mutations, actions)
- **~20 UI screens** across student and admin experiences
- **10 implementation milestones** with clear acceptance criteria
- **Rotating code attendance system** as primary anti-cheat mechanism

**Recommended build order:**
1. Auth + Profiles (foundation)
2. Service submissions + Admin review (core value)
3. Meetings + Attendance (secondary core feature)
4. Notifications (polish)
5. Calendar + Opportunities (nice-to-have)
6. Exports + Enhancements (final polish)
